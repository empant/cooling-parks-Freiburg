---
title: "BS CR built up areas vs. parks"
output: pdf
---

```{r}
bootstrap_slope <- function(site1_data, site2_data, site1_name, site2_name, 
                           season = NULL, n_boot = 5000) {
  # Create a copy of the data frames to avoid modifying the originals
  data1 <- site1_data
  data2 <- site2_data
  
  # Filter by season if specified
  if (!is.null(season)) {
    season_filter <- data1$phenophase == season
    data1 <- data1[season_filter, ]
    data2 <- data2[season_filter, ]
  }
  
  # Get cooling rates
  site1_cooling <- data1$meanCR_4hours
  site2_cooling <- data2$meanCR_4hours
  
  # Remove any NA values
  valid_indices <- which(!is.na(site1_cooling) & !is.na(site2_cooling))
  site1_cooling <- site1_cooling[valid_indices]
  site2_cooling <- site2_cooling[valid_indices]
  
  n <- length(site1_cooling)
  
  # Initialize vectors to store bootstrap estimates
  slopes <- numeric(n_boot)
  r_squared <- numeric(n_boot)
  
  # Run bootstrap iterations
  for(i in 1:n_boot) {
    # Sample with replacement
    indices <- sample(1:n, n, replace = TRUE)
    boot_data1 <- site1_cooling[indices]
    boot_data2 <- site2_cooling[indices]
    
    # Fit model with park (site1) as predictor
    boot_model <- lm(boot_data2 ~ boot_data1)
    
    # Store results
    slopes[i] <- coef(boot_model)[2]
    r_squared[i] <- summary(boot_model)$r.squared
  }
  
  # Calculate confidence intervals
  slope_ci <- quantile(slopes, c(0.025, 0.975))
  r_squared_ci <- quantile(r_squared, c(0.025, 0.975))
  
  # Create results dataframe
  results <- data.frame(
    site1 = site1_name,
    site2 = site2_name,
    season = ifelse(is.null(season), "All seasons", season),
    n_observations = n,
    mean_slope = mean(slopes),
    slope_se = sd(slopes),
    median_slope = median(slopes),
    slope_lower_ci = slope_ci[1],
    slope_upper_ci = slope_ci[2],
    mean_r_squared = mean(r_squared),
    r_squared_lower_ci = r_squared_ci[1],
    r_squared_upper_ci = r_squared_ci[2]
  )
  
  # Create a basic histogram of bootstrap slopes
  hist(slopes, main = paste("Bootstrap distribution of slopes\n", 
                           site1_name, "vs", site2_name),
       xlab = "Slope", col = "lightblue", border = "white")
  abline(v = slope_ci, col = "red", lwd = 2, lty = 2)
  abline(v = mean(slopes), col = "blue", lwd = 2)
  
  # Return both the summary results and the full bootstrap samples
  return(list(
    results = results,
    bootstrap_slopes = slopes,
    bootstrap_r_squared = r_squared
  ))
}
```

KART
```{r}
bootstrap_resultsC <- bootstrap_slope(
  site1_data = FRSTGA_daily,  # predictor
  site2_data = FRKART_daily,  # response
  site1_name = "STGA Park",
  site2_name = "KART Urban",
  season = "full_canopy",     
  n_boot = 5000              
)

print(bootstrap_resultsC$results)
```
```{r}
bootstrap_resultsL <- bootstrap_slope(
  site1_data = FRSTGA_daily, 
  site2_data = FRKART_daily, 
  site1_name = "STGA Park",
  site2_name = "KART Urban",
  season = "leafless",    
  n_boot = 5000           
)

print(bootstrap_resultsL$results)
```

INST
```{r}
bootstrap_resultsC <- bootstrap_slope(
  site1_data = FRSTGA_daily,  
  site2_data = FRINST_daily,  
  site1_name = "STGA Park",
  site2_name = "INST Urban",
  season = "full_canopy",     
  n_boot = 5000     
)

print(bootstrap_resultsC$results)
```
```{r}
bootstrap_resultsL <- bootstrap_slope(
  site1_data = FRSTGA_daily,  
  site2_data = FRINST_daily,  
  site1_name = "STGA Park",
  site2_name = "INST Urban",
  season = "leafless",    
  n_boot = 5000              
)

print(bootstrap_resultsL$results)
```

SEEPARK
```{r}
bootstrap_resultsC <- bootstrap_slope(
  site1_data = FRSEEP_daily,  
  site2_data = FRBETZ_daily, 
  site1_name = "SEEP Park",
  site2_name = "BETZ Urban",
  season = "full_canopy",    
  n_boot = 5000              
)

print(bootstrap_resultsC$results)
```

```{r}
bootstrap_resultsL <- bootstrap_slope(
  site1_data = FRSEEP_daily,  
  site2_data = FRBETZ_daily,
  site1_name = "SEEP Park",
  site2_name = "BETZ Urban",
  season = "leafless",    
  n_boot = 5000             
)

print(bootstrap_resultsL$results)
```

FRIE MESS
```{r}
bootstrap_resultsC <- bootstrap_slope(
  site1_data = FRFRIE_daily, 
  site2_data = FRMESS_daily, 
  site1_name = "FRIE Park",
  site2_name = "MESS Urban",
  season = "full_canopy",    
  n_boot = 5000              
)

print(bootstrap_resultsC$results)
```

```{r}
bootstrap_resultsL <- bootstrap_slope(
  site1_data = FRFRIE_daily, 
  site2_data = FRMESS_daily,  
  site1_name = "FRIE Park",
  site2_name = "MESS Urban",
  season = "leafless",    
  n_boot = 5000             
)

print(bootstrap_resultsL$results)
```

```{r}
bootstrap_resultsC <- bootstrap_slope(
  site1_data = FRFRIE_daily,  
  site2_data = FRUNIK_daily,  
  site1_name = "FRIE Park",
  site2_name = "UNIK Urban",
  season = "full_canopy",    
  n_boot = 5000         
)

print(bootstrap_resultsC$results)
```

```{r}
bootstrap_resultsL <- bootstrap_slope(
  site1_data = FRFRIE_daily,  
  site2_data = FRUNIK_daily,
  site1_name = "FRIE Park",
  site2_name = "UNIK Urban",
  season = "leafless",    
  n_boot = 5000            
)

print(bootstrap_resultsL$results)
```





